name: ğŸš€ Android CI/CD Build Pipeline

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout main app
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸš€ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”‘ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ“¦ Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          build-tools: 34.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1

      - name: ğŸ§¹ Clean previous builds
        run: ./gradlew clean

      - name: ğŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: ğŸ” Create keystore for signing
        run: |
          keytool -genkey -v \
            -keystore app/release.keystore \
            -alias mykey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          
          echo "âœ… Keystore created!"

      - name: ğŸ—ï¸ Build Release APK (signed)
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=mykey \
            -Pandroid.injected.signing.key.password=android \
            --stacktrace

      - name: ğŸ”„ Rename APK files
        run: |
          APP_NAME="MyApp"
          
          BUILD_TIME=$(date +"%Y%m%d_%H%M%S")
          BUILD_NUMBER=${{ github.run_number }}
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/${APP_NAME}-debug-${BUILD_TIME}-build${BUILD_NUMBER}-${COMMIT_SHORT}.apk
          
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -f "$RELEASE_APK" ]; then
            RELEASE_DIR=$(dirname "$RELEASE_APK")
            mv "$RELEASE_APK" \
               "${RELEASE_DIR}/${APP_NAME}-release-${BUILD_TIME}-build${BUILD_NUMBER}-${COMMIT_SHORT}.apk"
          fi
          
          echo "âœ… Files renamed!"
          ls -lh app/build/outputs/apk/debug/
          ls -lh app/build/outputs/apk/release/

      - name: ğŸ“¦ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-build-${{ github.run_number }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: ğŸ“¦ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-build-${{ github.run_number }}
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: ğŸ“¤ Send Debug APK to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_USERNAME: ${{ secrets.TELEGRAM_USERNAME }}
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
            echo "âŒ Error: APK file not found!"
            exit 1
          fi
          
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_USERNAME" ]; then
            echo "âš ï¸ Warning: Telegram credentials not set! Skipping Telegram notification."
            echo "ğŸ’¡ To enable Telegram notifications, set TELEGRAM_BOT_TOKEN and TELEGRAM_USERNAME secrets in GitHub."
            exit 0
          fi
          
          APK_NAME=$(basename "$APK_PATH")
          COMMIT_MSG=$(git log -1 --pretty=%B)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          echo "ğŸ“¤ Sending Debug APK to Telegram..."
          echo "ğŸ“¦ APK: $APK_NAME"
          echo "ğŸ“ Size: $(du -h "$APK_PATH" | cut -f1)"
          echo "ğŸ‘¤ Username: $TELEGRAM_USERNAME"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -F document=@"$APK_PATH" \
          -F caption="ğŸ¤– Build Success - Debug APK
          
          ğŸ“¦ File: ${APK_NAME}
          ğŸ”¢ Build #${{ github.run_number }}
          ğŸ“± Branch: $BRANCH_NAME
          ğŸ‘¤ Committer: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          â° Time: $BUILD_TIME
          ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument?chat_id=@${TELEGRAM_USERNAME})
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Telegram API Error (HTTP $HTTP_CODE):"
            echo "$BODY"
            exit 1
          else
            echo "âœ… APK sent successfully to Telegram!"
          fi

      - name: ğŸ“¤ Send Release APK to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_USERNAME: ${{ secrets.TELEGRAM_USERNAME }}
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
            echo "âŒ Error: APK file not found!"
            exit 1
          fi
          
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_USERNAME" ]; then
            echo "âš ï¸ Warning: Telegram credentials not set! Skipping Telegram notification."
            echo "ğŸ’¡ To enable Telegram notifications, set TELEGRAM_BOT_TOKEN and TELEGRAM_USERNAME secrets in GitHub."
            exit 0
          fi
          
          APK_NAME=$(basename "$APK_PATH")
          COMMIT_MSG=$(git log -1 --pretty=%B)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          echo "ğŸ“¤ Sending Release APK to Telegram..."
          echo "ğŸ“¦ APK: $APK_NAME"
          echo "ğŸ“ Size: $(du -h "$APK_PATH" | cut -f1)"
          echo "ğŸ‘¤ Username: $TELEGRAM_USERNAME"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -F document=@"$APK_PATH" \
          -F caption="ğŸš€ Build Success - Release APK
          
          ğŸ“¦ File: ${APK_NAME}
          ğŸ”¢ Build #${{ github.run_number }}
          ğŸ“± Branch: $BRANCH_NAME
          ğŸ‘¤ Committer: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          â° Time: $BUILD_TIME
          ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument?chat_id=@${TELEGRAM_USERNAME})
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Telegram API Error (HTTP $HTTP_CODE):"
            echo "$BODY"
            exit 1
          else
            echo "âœ… APK sent successfully to Telegram!"
          fi

      - name: âŒ Send error notification to Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_USERNAME: ${{ secrets.TELEGRAM_USERNAME }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_USERNAME" ]; then
            echo "âš ï¸ Telegram credentials not set, skipping notification"
            exit 0
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "No commit message")
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
          -d chat_id=@${TELEGRAM_USERNAME} \
          -d parse_mode=HTML \
          -d text="âŒ <b>Build Failed!</b>
          
          ğŸ”¢ Build #${{ github.run_number }}
          ğŸ“± Branch: $BRANCH_NAME
          ğŸ‘¤ Committer: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          â° Time: $BUILD_TIME
          ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View logs</a>")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ Failed to send error notification (HTTP $HTTP_CODE)"
          fi

      - name: âœ… Build completed successfully!
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Build completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Debug APK built"
          echo "âœ… Release APK built"
          echo "ğŸ“¦ Files ready in Artifacts and Telegram"
          echo "ğŸ”¢ Build Number: ${{ github.run_number }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
