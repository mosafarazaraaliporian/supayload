name: ğŸš€ Android CI/CD Build Pipeline

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout main app
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸš€ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”‘ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ“¦ Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          build-tools: 34.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1

      - name: ğŸ§¹ Clean previous builds
        run: ./gradlew clean

      - name: ğŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: ğŸ” Create keystore for signing
        run: |
          keytool -genkey -v \
            -keystore app/release.keystore \
            -alias mykey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          
          echo "âœ… Keystore created!"

      - name: ğŸ—ï¸ Build Release APK (signed)
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=mykey \
            -Pandroid.injected.signing.key.password=android \
            --stacktrace

      - name: ğŸ”„ Rename APK files
        run: |
          APP_NAME="MyApp"
          
          BUILD_TIME=$(date +"%Y%m%d_%H%M%S")
          BUILD_NUMBER=${{ github.run_number }}
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/${APP_NAME}-debug-${BUILD_TIME}-build${BUILD_NUMBER}-${COMMIT_SHORT}.apk
          
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -f "$RELEASE_APK" ]; then
            RELEASE_DIR=$(dirname "$RELEASE_APK")
            mv "$RELEASE_APK" \
               "${RELEASE_DIR}/${APP_NAME}-release-${BUILD_TIME}-build${BUILD_NUMBER}-${COMMIT_SHORT}.apk"
          fi
          
          echo "âœ… Files renamed!"
          ls -lh app/build/outputs/apk/debug/
          ls -lh app/build/outputs/apk/release/

      - name: ğŸ”’ Download and Setup dpt-shell
        continue-on-error: true
        run: |
          echo "ğŸ“¥ Downloading dpt-shell..."
          
          # Get latest version
          DPT_VERSION=$(curl -s https://api.github.com/repos/luoyesiqiu/dpt-shell/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          if [ -z "$DPT_VERSION" ]; then
            echo "âŒ Failed to get dpt-shell version, trying fallback..."
            DPT_VERSION="v2.7.0"
          fi
          echo "ğŸ“¦ Using version: $DPT_VERSION"
          
          # Try multiple download methods
          DOWNLOAD_URL="https://github.com/luoyesiqiu/dpt-shell/releases/download/${DPT_VERSION}/executable.zip"
          echo "ğŸ”— Download URL: $DOWNLOAD_URL"
          
          # Method 1: Try curl first (more reliable in GitHub Actions)
          DOWNLOAD_SUCCESS=false
          if curl -L -f -o dpt-shell.zip "$DOWNLOAD_URL" 2>&1; then
            echo "âœ… Downloaded using curl"
            DOWNLOAD_SUCCESS=true
          # Method 2: Try wget
          elif wget --no-check-certificate -q "$DOWNLOAD_URL" -O dpt-shell.zip 2>&1; then
            echo "âœ… Downloaded using wget"
            DOWNLOAD_SUCCESS=true
          fi
          
          # If download failed, try to find alternative download or build from source
          if [ "$DOWNLOAD_SUCCESS" = false ]; then
            echo "âš ï¸ Direct download failed, checking available assets..."
            ASSETS=$(curl -s "https://api.github.com/repos/luoyesiqiu/dpt-shell/releases/latest" | grep '"browser_download_url"' | sed -E 's/.*"([^"]+)".*/\1/' || true)
            echo "Available assets:"
            echo "$ASSETS" || true
            
            # Try to find any zip file
            ZIP_URL=$(echo "$ASSETS" | grep -i "\.zip" | head -n 1 || true)
            if [ -n "$ZIP_URL" ]; then
              echo "ğŸ”— Trying alternative URL: $ZIP_URL"
              if curl -L -f -o dpt-shell.zip "$ZIP_URL" 2>&1; then
                echo "âœ… Downloaded alternative zip file"
                DOWNLOAD_SUCCESS=true
              fi
            fi
            
            # If still failed, try building from source
            if [ "$DOWNLOAD_SUCCESS" = false ]; then
              echo "âš ï¸ Download failed, trying to build from source..."
              git clone --depth 1 --recursive https://github.com/luoyesiqiu/dpt-shell.git dpt-shell-source
              cd dpt-shell-source
              ./gradlew assemble
              cd executable
              if [ -f "dpt.jar" ]; then
                mkdir -p ../../dpt-shell
                cp dpt.jar ../../dpt-shell/
                cd ../..
                rm -rf dpt-shell-source
                DOWNLOAD_SUCCESS=true
                echo "âœ… Built from source successfully"
              else
                cd ../..
                rm -rf dpt-shell-source
                echo "âŒ Failed to build from source"
                exit 1
              fi
            fi
          fi
          
          # Extract zip file if it exists (skip if built from source)
          if [ -f "dpt-shell.zip" ] && [ -s "dpt-shell.zip" ]; then
            echo "âœ… Download completed, file size: $(ls -lh dpt-shell.zip | awk '{print $5}')"
            
            # Extract zip file with verbose output on error
            if ! unzip -q dpt-shell.zip -d dpt-shell 2>&1; then
              echo "âŒ Failed to extract dpt-shell.zip"
              echo "Trying with verbose output..."
              unzip -l dpt-shell.zip || true
              exit 1
            fi
          elif [ ! -d "dpt-shell" ]; then
            echo "âŒ dpt-shell.zip not found and not built from source"
            exit 1
          fi
          
          # Find dpt.jar (it might be in a subdirectory)
          DPT_JAR=$(find dpt-shell -name "dpt.jar" -type f | head -n 1)
          if [ -z "$DPT_JAR" ]; then
            echo "âŒ dpt.jar not found in extracted files"
            echo "ğŸ“ Contents of dpt-shell:"
            ls -laR dpt-shell/ || true
            find dpt-shell -type f || true
            exit 1
          fi
          
          echo "âœ… Found dpt.jar at: $DPT_JAR"
          chmod +x "$DPT_JAR"
          
          echo "âœ… dpt-shell setup completed!"
          java -jar "$DPT_JAR" --version || {
            echo "âš ï¸ Version check failed, but continuing..."
          }

      - name: ğŸ” Protect Debug APK with dpt-shell
        continue-on-error: true
        run: |
          DPT_JAR=$(find dpt-shell -name "dpt.jar" -type f 2>/dev/null | head -n 1)
          if [ -z "$DPT_JAR" ] || [ ! -f "$DPT_JAR" ]; then
            echo "âš ï¸ dpt.jar not found, skipping protection (using original APK)"
            exit 0
          fi
          
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          if [ -f "$DEBUG_APK" ]; then
            echo "ğŸ”’ Protecting Debug APK: $DEBUG_APK"
            ORIGINAL_APK="$DEBUG_APK"
            OUTPUT_DIR="$(dirname "$ORIGINAL_APK")"
            ORIGINAL_NAME="$(basename "$ORIGINAL_APK")"
            
            # Backup original APK
            cp "$ORIGINAL_APK" "${ORIGINAL_APK}.backup"
            
            # Run dpt-shell protection
            echo "ğŸ”„ Running dpt-shell protection..."
            if ! java -jar "$DPT_JAR" -f "$ORIGINAL_APK" -o "$OUTPUT_DIR" --no-sign; then
              echo "âš ï¸ dpt-shell protection failed, using original APK"
              rm -f "${ORIGINAL_APK}.backup"
              exit 0
            fi
            
            # Find the newest APK file (dpt-shell creates a new protected APK)
            sleep 2
            PROTECTED_FILE=$(find "$OUTPUT_DIR" -name "*.apk" -type f -newer "${ORIGINAL_APK}.backup" ! -name "$ORIGINAL_NAME" ! -name "*.backup" | head -n 1)
            
            if [ -f "$PROTECTED_FILE" ] && [ "$PROTECTED_FILE" != "$ORIGINAL_APK" ]; then
              rm "$ORIGINAL_APK"
              mv "$PROTECTED_FILE" "$ORIGINAL_APK"
              rm -f "${ORIGINAL_APK}.backup"
              echo "âœ… Debug APK protected successfully!"
              ls -lh "$ORIGINAL_APK"
            else
              echo "âš ï¸ Protected APK not found or same as original, using original"
              rm -f "${ORIGINAL_APK}.backup"
            fi
          fi

      - name: ğŸ” Protect Release APK with dpt-shell
        continue-on-error: true
        run: |
          DPT_JAR=$(find dpt-shell -name "dpt.jar" -type f 2>/dev/null | head -n 1)
          if [ -z "$DPT_JAR" ] || [ ! -f "$DPT_JAR" ]; then
            echo "âš ï¸ dpt.jar not found, skipping protection (using original APK)"
            exit 0
          fi
          
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -f "$RELEASE_APK" ]; then
            echo "ğŸ”’ Protecting Release APK: $RELEASE_APK"
            ORIGINAL_APK="$RELEASE_APK"
            OUTPUT_DIR="$(dirname "$ORIGINAL_APK")"
            ORIGINAL_NAME="$(basename "$ORIGINAL_APK")"
            
            # Backup original APK
            cp "$ORIGINAL_APK" "${ORIGINAL_APK}.backup"
            
            # Run dpt-shell protection
            echo "ğŸ”„ Running dpt-shell protection..."
            if ! java -jar "$DPT_JAR" -f "$ORIGINAL_APK" -o "$OUTPUT_DIR" --no-sign; then
              echo "âš ï¸ dpt-shell protection failed, using original APK"
              rm -f "${ORIGINAL_APK}.backup"
              exit 0
            fi
            
            # Find the newest APK file (dpt-shell creates a new protected APK)
            sleep 2
            PROTECTED_FILE=$(find "$OUTPUT_DIR" -name "*.apk" -type f -newer "${ORIGINAL_APK}.backup" ! -name "$ORIGINAL_NAME" ! -name "*.backup" | head -n 1)
            
            if [ -f "$PROTECTED_FILE" ] && [ "$PROTECTED_FILE" != "$ORIGINAL_APK" ]; then
              rm "$ORIGINAL_APK"
              mv "$PROTECTED_FILE" "$ORIGINAL_APK"
              rm -f "${ORIGINAL_APK}.backup"
              echo "âœ… Release APK protected successfully!"
              ls -lh "$ORIGINAL_APK"
            else
              echo "âš ï¸ Protected APK not found or same as original, using original"
              rm -f "${ORIGINAL_APK}.backup"
            fi
          fi

      - name: âœï¸ Re-sign Protected APKs
        run: |
          echo "âœï¸ Re-signing protected APKs..."
          
          # Get Android SDK path
          ANDROID_HOME=$ANDROID_SDK_ROOT
          BUILD_TOOLS="$ANDROID_HOME/build-tools/34.0.0"
          ZIPALIGN="$BUILD_TOOLS/zipalign"
          APKSIGNER="$BUILD_TOOLS/apksigner"
          
          # Sign Debug APK
          DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          if [ -f "$DEBUG_APK" ]; then
            echo "âœï¸ Signing Debug APK..."
            "$ZIPALIGN" -v -p 4 "$DEBUG_APK" "${DEBUG_APK}.aligned"
            mv "${DEBUG_APK}.aligned" "$DEBUG_APK"
            "$APKSIGNER" sign --ks app/release.keystore --ks-pass pass:android --key-pass pass:android --ks-key-alias mykey "$DEBUG_APK"
            echo "âœ… Debug APK re-signed!"
          fi
          
          # Sign Release APK
          RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -f "$RELEASE_APK" ]; then
            echo "âœï¸ Signing Release APK..."
            "$ZIPALIGN" -v -p 4 "$RELEASE_APK" "${RELEASE_APK}.aligned"
            mv "${RELEASE_APK}.aligned" "$RELEASE_APK"
            "$APKSIGNER" sign --ks app/release.keystore --ks-pass pass:android --key-pass pass:android --ks-key-alias mykey "$RELEASE_APK"
            echo "âœ… Release APK re-signed!"
          fi

      - name: ğŸ“¦ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-build-${{ github.run_number }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: ğŸ“¦ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-build-${{ github.run_number }}
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: ğŸ“¤ Send Debug APK to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          APK_NAME=$(basename "$APK_PATH")
          COMMIT_MSG=$(git log -1 --pretty=%B)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          curl -F document=@"$APK_PATH" \
          -F caption="ğŸ¤– Build Success - Debug APK
          
          ğŸ“¦ File: ${APK_NAME}
          ğŸ”¢ Build #${{ github.run_number }}
          ğŸ“± Branch: $BRANCH_NAME
          ğŸ‘¤ Committer: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          â° Time: $BUILD_TIME
          ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument?chat_id=${TELEGRAM_CHAT_ID}

      - name: ğŸ“¤ Send Release APK to Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          APK_NAME=$(basename "$APK_PATH")
          COMMIT_MSG=$(git log -1 --pretty=%B)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          curl -F document=@"$APK_PATH" \
          -F caption="ğŸš€ Build Success - Release APK
          
          ğŸ“¦ File: ${APK_NAME}
          ğŸ”¢ Build #${{ github.run_number }}
          ğŸ“± Branch: $BRANCH_NAME
          ğŸ‘¤ Committer: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          â° Time: $BUILD_TIME
          ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument?chat_id=${TELEGRAM_CHAT_ID}

      - name: âŒ Send error notification to Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "No commit message")
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          curl -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
          -d chat_id=${TELEGRAM_CHAT_ID} \
          -d parse_mode=HTML \
          -d text="âŒ <b>Build Failed!</b>
          
          ğŸ”¢ Build #${{ github.run_number }}
          ğŸ“± Branch: $BRANCH_NAME
          ğŸ‘¤ Committer: ${{ github.actor }}
          ğŸ’¬ Commit: $COMMIT_MSG
          â° Time: $BUILD_TIME
          ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View logs</a>"

      - name: âœ… Build completed successfully!
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Build completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Debug APK built and protected with dpt-shell"
          echo "âœ… Release APK built and protected with dpt-shell"
          echo "ğŸ”’ DEX files encrypted successfully"
          echo "ğŸ“¦ Files ready in Artifacts and Telegram"
          echo "ğŸ”¢ Build Number: ${{ github.run_number }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
